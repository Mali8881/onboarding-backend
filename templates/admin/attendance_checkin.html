{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div style="max-width: 760px; margin: 16px auto;">
  <h1 style="margin-bottom: 8px;">–û—Ç–º–µ—Ç–∫–∞ –≤ –æ—Ñ–∏—Å–µ</h1>
  <p style="margin-bottom: 16px; color: #6b7280;">
    –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –∏ —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ—Ç–∏—Ç —Ñ–∞–∫—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –≤ –æ—Ñ–∏—Å–µ.
  </p>

  <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #fff;">
    <button id="checkin-btn" type="button" class="button default" style="min-width: 180px;">
      –Ø –≤ –æ—Ñ–∏—Å–µ
    </button>
    <div id="checkin-status" style="margin-top: 12px; font-weight: 600;">‚ö™ –ù–µ –æ—Ç–º–µ—á–µ–Ω</div>
    <div id="checkin-meta" style="margin-top: 6px; color: #6b7280;"></div>
  </div>
</div>

<script>
  (function () {
    const btn = document.getElementById("checkin-btn");
    const statusEl = document.getElementById("checkin-status");
    const metaEl = document.getElementById("checkin-meta");
    const apiUrl = "{{ checkin_api_url }}";

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return "";
    }

    function setLoading(isLoading) {
      btn.disabled = isLoading;
      btn.textContent = isLoading ? "–ü—Ä–æ–≤–µ—Ä—è–µ–º..." : "–Ø –≤ –æ—Ñ–∏—Å–µ";
    }

    async function sendCheckIn(lat, lon, accuracy) {
      const csrf = getCookie("csrftoken");
      const response = await fetch(apiUrl, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrf,
        },
        body: JSON.stringify({
          latitude: lat,
          longitude: lon,
          accuracy_m: accuracy,
        }),
      });

      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(data.detail || "–û—à–∏–±–∫–∞ check-in");
      }
      return data;
    }

    btn.addEventListener("click", function () {
      if (!navigator.geolocation) {
        statusEl.textContent = "‚ö™ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º";
        return;
      }

      setLoading(true);
      statusEl.textContent = "‚ö™ –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã...";
      metaEl.textContent = "";

      navigator.geolocation.getCurrentPosition(
        async function (position) {
          try {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy || null;
            const result = await sendCheckIn(lat, lon, accuracy);

            if (result.in_office) {
              statusEl.textContent = "üü¢ –í –æ—Ñ–∏—Å–µ";
            } else {
              statusEl.textContent = "‚ö™ –í–Ω–µ –æ—Ñ–∏—Å–∞";
            }

            metaEl.textContent = `–°—Ç–∞—Ç—É—Å: ${result.status}. –î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${Math.round(result.distance_m || 0)} –º`;
          } catch (err) {
            statusEl.textContent = "‚ö™ –ù–µ –æ—Ç–º–µ—á–µ–Ω";
            metaEl.textContent = err.message || "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏";
          } finally {
            setLoading(false);
          }
        },
        function (err) {
          setLoading(false);
          statusEl.textContent = "‚ö™ –ù–µ –æ—Ç–º–µ—á–µ–Ω";
          if (err.code === 1) {
            metaEl.textContent = "–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.";
          } else {
            metaEl.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.";
          }
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0,
        }
      );
    });
  })();
</script>
{% endblock %}
