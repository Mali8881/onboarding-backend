{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div style="max-width: 1024px; margin: 16px auto;">
  <h1 style="margin-bottom: 8px;">Отметка и посещаемость</h1>

  {% if can_checkin %}
    <p style="margin-bottom: 16px; color: #6b7280;">
      Быстрый check-in и ваша личная история посещений.
    </p>
  {% else %}
    <p style="margin-bottom: 16px; color: #6b7280;">
      Для вашей роли check-in отключен. Доступен просмотр посещаемости по дню и по календарю.
    </p>
  {% endif %}

  <div style="display:grid; grid-template-columns: 1fr; gap: 16px;">
    {% if can_checkin %}
      <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #fff;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">1) Быстрый check-in</div>
        <div style="display:flex; gap:8px; flex-wrap: wrap;">
          <button id="checkin-office-btn" type="button" class="button default" style="min-width: 180px;">Я в офисе</button>
          <button id="checkin-online-btn" type="button" class="button" style="min-width: 180px;">Я онлайн</button>
        </div>
        <div id="checkin-status" style="margin-top: 12px; font-weight: 600;">Статус не обновлен</div>
        <div id="checkin-meta" style="margin-top: 6px; color: #6b7280;"></div>
        <div style="margin-top: 10px; color: #6b7280; font-size: 13px;">Ограничение: только один check-in в день.</div>
      </div>

      <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #fff;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">2) Сегодня</div>
        <div style="display:flex; gap: 8px; align-items:center; flex-wrap:wrap;">
          <span style="font-size: 13px; color: #6b7280;">Дата: {{ today }}</span>
          {% if today_mark %}
            <span style="padding: 4px 10px; border-radius: 999px; background: #e0f2fe; color: #075985; font-weight: 600;">{{ today_mark.status_ru }}</span>
            <span style="font-size: 13px; color: #6b7280;">Комментарий: {{ today_mark.comment|default:"-" }}</span>
          {% else %}
            <span style="padding: 4px 10px; border-radius: 999px; background: #fef3c7; color: #92400e; font-weight: 600;">Отметки за сегодня нет</span>
          {% endif %}
        </div>
      </div>

      <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #fff;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">3) Мои последние отметки посещаемости</div>
        <div style="overflow:auto;">
          <table style="width:100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Дата</th>
                <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Статус</th>
                <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Комментарий</th>
              </tr>
            </thead>
            <tbody>
              {% for mark in recent_marks %}
                <tr>
                  <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ mark.date }}</td>
                  <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ mark.status_ru }}</td>
                  <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ mark.comment|default:"-" }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="3" style="padding: 8px; color:#6b7280;">Пока нет данных.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    {% if can_view_company_attendance %}
      <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #fff;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 10px;">1) Кто отмечался за день</div>
        <form method="get" style="display:flex; gap:8px; align-items:end; flex-wrap: wrap; margin-bottom: 10px;">
          <div>
            <label style="display:block; font-size:12px; color:#6b7280; margin-bottom:4px;">Дата</label>
            <input type="date" name="date" value="{{ selected_date|date:'Y-m-d' }}" style="padding: 8px; border:1px solid #d1d5db; border-radius:8px;">
          </div>
          <button type="submit" class="button default">Показать</button>
        </form>
        <div style="overflow:auto;">
          <table style="width:100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Сотрудник</th>
                <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Отдел</th>
                <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Роль</th>
                <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Статус</th>
              </tr>
            </thead>
            <tbody>
              {% for mark in day_marks %}
                <tr>
                  <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ mark.user.username }}</td>
                  <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ mark.user.department.name|default:"-" }}</td>
                  <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ mark.user.role.name|default:"-" }}</td>
                  <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ mark.status_ru }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="4" style="padding: 8px; color:#6b7280;">За выбранную дату отметок нет.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #fff;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 10px;">2) Календарь посещаемости (по месяцу)</div>
        <form method="get" style="display:flex; gap:8px; align-items:end; flex-wrap: wrap; margin-bottom: 10px;">
          <div>
            <label style="display:block; font-size:12px; color:#6b7280; margin-bottom:4px;">Месяц</label>
            <input type="month" name="month" value="{{ selected_month }}" style="padding: 8px; border:1px solid #d1d5db; border-radius:8px;">
          </div>
          <button type="submit" class="button default">Показать</button>
        </form>
        <div style="overflow:auto;">
          <table style="width:100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Дата</th>
                <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Количество отметившихся</th>
              </tr>
            </thead>
            <tbody>
              {% for row in month_counts %}
                <tr>
                  <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ row.date }}</td>
                  <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ row.total }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="2" style="padding: 8px; color:#6b7280;">За выбранный месяц отметок нет.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #fff;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 10px;">3) Детально по дням (сотрудники внутри даты)</div>
        {% for day in month_day_details %}
          <div style="margin-bottom: 14px; border: 1px solid #f3f4f6; border-radius: 10px; padding: 10px;">
            <div style="font-weight: 700; margin-bottom: 6px;">{{ day.date }}</div>
            <div style="overflow:auto;">
              <table style="width:100%; border-collapse: collapse;">
                <thead>
                  <tr>
                    <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Сотрудник</th>
                    <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Отдел</th>
                    <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Роль</th>
                    <th style="text-align:left; padding: 8px; border-bottom:1px solid #e5e7eb;">Статус</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in day.items %}
                    <tr>
                      <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ item.username }}</td>
                      <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ item.department }}</td>
                      <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ item.role }}</td>
                      <td style="padding: 8px; border-bottom:1px solid #f3f4f6;">{{ item.status_ru }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% empty %}
          <div style="color:#6b7280;">За выбранный месяц детальных данных нет.</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<script>
  (function () {
    const officeBtn = document.getElementById("checkin-office-btn");
    const onlineBtn = document.getElementById("checkin-online-btn");
    const statusEl = document.getElementById("checkin-status");
    const metaEl = document.getElementById("checkin-meta");
    const apiUrl = "{{ checkin_api_url }}";

    if (!officeBtn || !onlineBtn || !statusEl || !metaEl) {
      return;
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return "";
    }

    function setLoading(isLoading, mode) {
      officeBtn.disabled = isLoading;
      onlineBtn.disabled = isLoading;
      if (isLoading) {
        statusEl.textContent = mode === "office" ? "Проверяем офисную сеть..." : "Отмечаем онлайн...";
      }
    }

    async function sendCheckIn(workMode) {
      const csrf = getCookie("csrftoken");
      const response = await fetch(apiUrl, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrf,
        },
        body: JSON.stringify({ work_mode: workMode }),
      });

      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(data.detail || "Ошибка check-in");
      }
      return data;
    }

    async function performCheckIn(mode) {
      setLoading(true, mode);
      metaEl.textContent = "";
      try {
        const result = await sendCheckIn(mode);
        statusEl.textContent = `Статус: ${result.status}`;
        metaEl.textContent = result.ip_valid !== undefined
          ? `IP доступ: ${result.ip_valid ? "да" : "нет"}`
          : "Отметка сохранена";
        setTimeout(() => window.location.reload(), 700);
      } catch (err) {
        statusEl.textContent = "Не отмечен";
        metaEl.textContent = err.message || "Ошибка проверки";
      } finally {
        setLoading(false, mode);
      }
    }

    officeBtn.addEventListener("click", function () {
      performCheckIn("office");
    });

    onlineBtn.addEventListener("click", function () {
      performCheckIn("online");
    });
  })();
</script>
{% endblock %}
